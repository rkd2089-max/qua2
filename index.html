<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Q&A ê²Œì‹œíŒ</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="container">
      <h1>Q&A ê²Œì‹œíŒ</h1>
    </div>
  </header>

  <div class="container">
    <!-- ê²€ìƒ‰ ë° í•„í„° ì„¹ì…˜ -->
    <div class="search-filter-section">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ì§ˆë¬¸ ì œëª© ë˜ëŠ” ë‚´ìš©ì„ ê²€ìƒ‰í•˜ì„¸ìš”...">
        <button class="btn btn-primary" onclick="searchQuestions()">ê²€ìƒ‰</button>
      </div>
      <div class="filter-sort-section">
        <div class="filter-group">
          <label for="categoryFilter">ì¹´í…Œê³ ë¦¬:</label>
          <select id="categoryFilter" onchange="loadQuestions()">
            <option value="all">ì „ì²´</option>
            <option value="ììœ ">ììœ </option>
            <option value="ê°œë°œ">ê°œë°œ</option>
            <option value="ì§ˆë¬¸">ì§ˆë¬¸</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="sortBy">ì •ë ¬:</label>
          <select id="sortBy" onchange="loadQuestions()">
            <option value="latest">ìµœì‹ ìˆœ</option>
            <option value="views">ì¡°íšŒìˆœ</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="location.href='write.html'">ì§ˆë¬¸ ì‘ì„±</button>
      </div>
    </div>

    <!-- ì§ˆë¬¸ ëª©ë¡ -->
    <div class="question-list" id="questionList">
      <!-- ì§ˆë¬¸ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>

    <!-- ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ -->
    <div class="empty-state" id="emptyState" style="display: none;">
      <div class="empty-state-icon">ğŸ“</div>
      <div class="empty-state-message">ë“±ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ì‚­ì œ í™•ì¸</div>
      <div class="modal-body">
        <p>ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="password" id="deletePassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px;">
        <p id="deleteError" style="color: #e74c3c; margin-top: 10px; display: none;">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
        <button class="btn btn-danger" onclick="confirmDelete()">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- ì„¤ì • ë° ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="firebase-config.js"></script>
  <script src="script.js"></script>
  <script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§ˆë¬¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', () => {
      loadQuestions();
      
      // ê²€ìƒ‰ ì…ë ¥ì°½ì—ì„œ Enter í‚¤ ì²˜ë¦¬
      document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          searchQuestions();
        }
      });
    });

    let currentDeleteId = null;
    let currentDeleteType = null; // 'question' or 'answer'

    // ì§ˆë¬¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadQuestions() {
      const questionList = document.getElementById('questionList');
      const emptyState = document.getElementById('emptyState');
      questionList.innerHTML = '';
      
      const categoryFilter = document.getElementById('categoryFilter').value;
      const sortBy = document.getElementById('sortBy').value;
      
      try {
        let query = db.collection('questions');
        
        // ì¹´í…Œê³ ë¦¬ í•„í„° ì ìš©
        if (categoryFilter !== 'all') {
          query = query.where('category', '==', categoryFilter);
        }
        
        // ì •ë ¬ ì ìš©
        if (sortBy === 'latest') {
          query = query.orderBy('createdAt', 'desc');
        } else {
          query = query.orderBy('viewCount', 'desc');
        }
        
        const snapshot = await query.get();
        
        if (snapshot.empty) {
          emptyState.style.display = 'block';
          return;
        }
        
        emptyState.style.display = 'none';
        
        snapshot.forEach(doc => {
          const question = doc.data();
          const questionCard = createQuestionCard(doc.id, question);
          questionList.appendChild(questionCard);
        });
      } catch (error) {
        console.error('ì§ˆë¬¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        alert('ì§ˆë¬¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì§ˆë¬¸ ì¹´ë“œ ìƒì„±
    function createQuestionCard(id, question) {
      const card = document.createElement('div');
      card.className = 'question-card';
      card.onclick = () => {
        location.href = `question.html?id=${id}`;
      };
      
      const categoryBadge = question.category ? `<span class="question-category">${question.category}</span>` : '';
      
      card.innerHTML = `
        <div class="question-header">
          <div>
            <div class="question-title">${escapeHtml(question.title)}${categoryBadge}</div>
          </div>
        </div>
        <div class="question-content">${escapeHtml(question.content)}</div>
        <div class="question-meta">
          <span>ì‘ì„±ì: ${escapeHtml(question.nickname)}</span>
          <span>ì‘ì„±ì¼: ${formatDate(question.createdAt)}</span>
          <span>ì¡°íšŒìˆ˜: ${question.viewCount || 0}</span>
        </div>
      `;
      
      return card;
    }

    // ê²€ìƒ‰ ê¸°ëŠ¥
    function searchQuestions() {
      const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
      
      if (!searchTerm) {
        loadQuestions();
        return;
      }
      
      const questionList = document.getElementById('questionList');
      const emptyState = document.getElementById('emptyState');
      questionList.innerHTML = '';
      
      const categoryFilter = document.getElementById('categoryFilter').value;
      const sortBy = document.getElementById('sortBy').value;
      
      db.collection('questions').get().then(snapshot => {
        let questions = [];
        
        snapshot.forEach(doc => {
          const question = doc.data();
          const title = question.title.toLowerCase();
          const content = question.content.toLowerCase();
          
          // ì¹´í…Œê³ ë¦¬ í•„í„° í™•ì¸
          if (categoryFilter !== 'all' && question.category !== categoryFilter) {
            return;
          }
          
          // ê²€ìƒ‰ì–´ê°€ ì œëª©ì´ë‚˜ ë‚´ìš©ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          if (title.includes(searchTerm) || content.includes(searchTerm)) {
            questions.push({ id: doc.id, ...question });
          }
        });
        
        // ì •ë ¬
        if (sortBy === 'latest') {
          questions.sort((a, b) => {
            const dateA = a.createdAt?.toDate() || new Date(0);
            const dateB = b.createdAt?.toDate() || new Date(0);
            return dateB - dateA;
          });
        } else {
          questions.sort((a, b) => (b.viewCount || 0) - (a.viewCount || 0));
        }
        
        if (questions.length === 0) {
          emptyState.style.display = 'block';
          return;
        }
        
        emptyState.style.display = 'none';
        
        questions.forEach(question => {
          const questionCard = createQuestionCard(question.id, question);
          questionList.appendChild(questionCard);
        });
      }).catch(error => {
        console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    }

    // ì‚­ì œ ëª¨ë‹¬ ì—´ê¸°
    function openDeleteModal(id, type) {
      currentDeleteId = id;
      currentDeleteType = type;
      document.getElementById('deleteModal').style.display = 'block';
      document.getElementById('deletePassword').value = '';
      document.getElementById('deleteError').style.display = 'none';
      document.getElementById('deletePassword').focus();
    }

    // ì‚­ì œ ëª¨ë‹¬ ë‹«ê¸°
    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
      currentDeleteId = null;
      currentDeleteType = null;
    }

    // ì‚­ì œ í™•ì¸
    async function confirmDelete() {
      const password = document.getElementById('deletePassword').value;
      const deleteError = document.getElementById('deleteError');
      const correctPassword = 'jz2073jz';
      
      if (password !== correctPassword) {
        deleteError.style.display = 'block';
        return;
      }
      
      try {
        if (currentDeleteType === 'question') {
          // ì§ˆë¬¸ ì‚­ì œ ì‹œ ê´€ë ¨ ë‹µë³€ë„ ëª¨ë‘ ì‚­ì œ
          const answersSnapshot = await db.collection('answers')
            .where('questionId', '==', currentDeleteId)
            .get();
          
          const deletePromises = answersSnapshot.docs.map(doc => doc.ref.delete());
          await Promise.all(deletePromises);
          
          await db.collection('questions').doc(currentDeleteId).delete();
          alert('ì§ˆë¬¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadQuestions();
        } else if (currentDeleteType === 'answer') {
          await db.collection('answers').doc(currentDeleteId).delete();
          alert('ë‹µë³€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          // ì§ˆë¬¸ ìƒì„¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          const urlParams = new URLSearchParams(window.location.search);
          const questionId = urlParams.get('id');
          if (questionId) {
            location.reload();
          }
        }
        
        closeDeleteModal();
      } catch (error) {
        console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
      const modal = document.getElementById('deleteModal');
      if (event.target === modal) {
        closeDeleteModal();
      }
    }
  </script>
</body>
</html>
